# OAuth2 Authentication with Supabase - MVP Implementation Plan

**Project:** d3f4ult.tv Crypto Stream Dashboard
**Feature:** User Authentication (Twitter/Discord) + Persistent Wallets
**Solution:** Supabase (Backend-as-a-Service)
**Date:** 2025-11-12
**Status:** Ready to Implement

---

## 1. Executive Summary

### Goal
Implement OAuth2 authentication using Supabase to enable:
- ✅ Sign in with Twitter/X or Discord
- ✅ Persistent wallet storage across sessions/devices
- ✅ Discord role verification for special badges (role: 1435799986423205951)
- ✅ User profile management

### Why Supabase?
- **Built-in OAuth2** - Twitter & Discord providers ready to use (no Passport.js needed)
- **PostgreSQL** - Managed database with auto-generated REST API
- **Fast Setup** - 2-3 hours vs 8-10 hours custom implementation
- **Row Level Security** - Users can only access their own data
- **Real-time** - WebSocket subscriptions for future features (price alerts)
- **Free Tier** - 500MB database, unlimited API requests

### Dual Authentication Architecture
```
┌──────────────────────────────────────────────────────┐
│  Profile Auth (OAuth2) via Supabase                  │
│  - Twitter/Discord login for user account            │
│  - Profile settings, avatar, username                │
│  - Connected accounts, saved wallets                 │
│  - Discord role badges                               │
└──────────────────────────────────────────────────────┘
                    ↓ SEPARATE FROM ↓
┌──────────────────────────────────────────────────────┐
│  Crypto Wallet Auth (Web3) - Keep Existing          │
│  - Phantom wallet (Solana) - for signing/trading    │
│  - MetaMask (BSC) - for signing/trading             │
│  - NOT used for profile authentication              │
└──────────────────────────────────────────────────────┘
```

### Timeline
- **MVP Setup:** 2-3 hours
- **Full Testing:** 1 hour
- **Total:** 3-4 hours

---

## 2. Technology Stack

### 2.1 Backend (Supabase Cloud)
- **@supabase/supabase-js** - Client SDK
- **PostgreSQL** - Managed database
- **Built-in Auth** - OAuth2 providers
- **Auto-generated API** - REST endpoints with RLS

### 2.2 Frontend (Existing React App)
- **@supabase/auth-ui-react** (optional) - Pre-built auth components
- **React Context** - Auth state management
- **wouter** (existing) - Routing
- **@tanstack/react-query** (existing) - Data fetching

### 2.3 Crypto Wallet Layer (Unchanged)
- **@solana/wallet-adapter-react** - Phantom wallet
- **ethers.js** - MetaMask/BSC wallets

---

## 3. Supabase Setup

### 3.1 Create Supabase Project

1. Go to https://supabase.com
2. Create new project: "d3f4ult-dashboard"
3. Copy these credentials:
   - **Project URL:** `https://xxxxx.supabase.co`
   - **Anon Public Key:** `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`
   - **Service Role Key:** `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` (keep secret)

### 3.2 Configure OAuth Providers

#### Twitter OAuth2
1. Supabase Dashboard → Authentication → Providers → Twitter
2. Enable provider
3. Enter credentials from https://developer.twitter.com/portal
   - API Key (Client ID)
   - API Secret (Client Secret)
4. Callback URL (auto-generated by Supabase):
   `https://xxxxx.supabase.co/auth/v1/callback`
5. Scopes: `users.read`, `tweet.read`

#### Discord OAuth2
1. Supabase Dashboard → Authentication → Providers → Discord
2. Enable provider
3. Enter credentials from https://discord.com/developers/applications
   - Client ID
   - Client Secret
4. Callback URL (auto-generated by Supabase):
   `https://xxxxx.supabase.co/auth/v1/callback`
5. Scopes: `identify`, `email`, `guilds`, `guilds.members.read`

### 3.3 Environment Variables

Create `.env` file:
```bash
# Supabase (PUBLIC - safe for client-side)
VITE_SUPABASE_URL=https://xxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Server-side only (PRIVATE)
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Discord Bot for role verification
DISCORD_BOT_TOKEN=MTQzNTc5OTk4NjQyMzIwNTk1MQ...
DISCORD_GUILD_ID=935376916377137232
DISCORD_VIP_ROLE_ID=1435799986423205951
```

---

## 4. Database Schema (Supabase SQL Editor)

### 4.1 Create Tables

Run in Supabase SQL Editor:

```sql
-- Enable RLS (Row Level Security)
ALTER TABLE auth.users ENABLE ROW LEVEL SECURITY;

-- User profiles (extends Supabase auth.users)
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  username TEXT NOT NULL,
  avatar_url TEXT,
  discord_id TEXT UNIQUE,
  twitter_id TEXT UNIQUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Discord badges
CREATE TABLE public.user_badges (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
  badge_type TEXT NOT NULL, -- 'discord_vip', 'discord_member'
  discord_guild_id TEXT,
  discord_role_id TEXT,
  verified_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE,

  UNIQUE(user_id, badge_type)
);

-- Saved wallets (linked to user)
CREATE TABLE public.saved_wallets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
  address TEXT NOT NULL,
  label TEXT DEFAULT 'Unnamed Wallet',
  blockchain TEXT NOT NULL CHECK (blockchain IN ('solana', 'bsc')),
  is_verified BOOLEAN DEFAULT FALSE, -- Future: Did user prove ownership via signature?
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  UNIQUE(user_id, address, blockchain)
);

-- Indexes
CREATE INDEX idx_saved_wallets_user_id ON public.saved_wallets(user_id);
CREATE INDEX idx_user_badges_user_id ON public.user_badges(user_id);

-- Row Level Security Policies
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_badges ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.saved_wallets ENABLE ROW LEVEL SECURITY;

-- Profiles: Users can read own profile, insert on signup
CREATE POLICY "Users can view own profile" ON public.profiles
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can insert own profile" ON public.profiles
  FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON public.profiles
  FOR UPDATE USING (auth.uid() = id);

-- Badges: Users can only read own badges
CREATE POLICY "Users can view own badges" ON public.user_badges
  FOR SELECT USING (user_id = auth.uid());

-- Wallets: Users can only access own wallets
CREATE POLICY "Users can view own wallets" ON public.saved_wallets
  FOR SELECT USING (user_id = auth.uid());

CREATE POLICY "Users can insert own wallets" ON public.saved_wallets
  FOR INSERT WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can update own wallets" ON public.saved_wallets
  FOR UPDATE USING (user_id = auth.uid());

CREATE POLICY "Users can delete own wallets" ON public.saved_wallets
  FOR DELETE USING (user_id = auth.uid());

-- Function to auto-create profile on signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, username, avatar_url, discord_id, twitter_id)
  VALUES (
    NEW.id,
    COALESCE(NEW.raw_user_meta_data->>'user_name', NEW.raw_user_meta_data->>'full_name', 'User'),
    NEW.raw_user_meta_data->>'avatar_url',
    NEW.raw_user_meta_data->>'provider_id',
    NEW.raw_user_meta_data->>'provider_id'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger to create profile on auth.users insert
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

---

## 5. Backend Implementation

### 5.1 Install Dependencies

```bash
npm install @supabase/supabase-js
```

### 5.2 Create Supabase Client

**File:** `server/config/supabase.ts`
```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.VITE_SUPABASE_URL!;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

// Server-side client with service role (bypasses RLS for admin operations)
export const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey);
```

**File:** `client/src/lib/supabase.ts`
```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL!;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY!;

// Client-side supabase client (respects RLS)
export const supabase = createClient(supabaseUrl, supabaseAnonKey);
```

### 5.3 Discord Role Verification Service

**File:** `server/services/discordRoleService.ts`
```typescript
import axios from 'axios';
import { supabaseAdmin } from '../config/supabase';

const DISCORD_BOT_TOKEN = process.env.DISCORD_BOT_TOKEN!;
const DISCORD_GUILD_ID = process.env.DISCORD_GUILD_ID!;
const DISCORD_VIP_ROLE_ID = process.env.DISCORD_VIP_ROLE_ID!;

export async function verifyDiscordRole(userId: string, discordId: string): Promise<boolean> {
  try {
    // Fetch member data from Discord API
    const response = await axios.get(
      `https://discord.com/api/v10/guilds/${DISCORD_GUILD_ID}/members/${discordId}`,
      { headers: { Authorization: `Bot ${DISCORD_BOT_TOKEN}` } }
    );

    const member = response.data;
    const hasVipRole = member.roles.includes(DISCORD_VIP_ROLE_ID);

    if (hasVipRole) {
      // Add badge to user_badges table
      await supabaseAdmin.from('user_badges').upsert({
        user_id: userId,
        badge_type: 'discord_vip',
        discord_guild_id: DISCORD_GUILD_ID,
        discord_role_id: DISCORD_VIP_ROLE_ID,
      });
    }

    return hasVipRole;
  } catch (error) {
    console.error('[Discord] Role verification failed:', error);
    return false;
  }
}
```

### 5.4 Backend API Routes for Wallets

**File:** `server/routes/wallets.ts`
```typescript
import { Router } from 'express';
import { supabaseAdmin } from '../config/supabase';
import { addWalletSchema } from '@shared/schema';

const router = Router();

// Middleware to extract user from Supabase JWT
async function requireAuth(req: any, res: any, next: any) {
  const token = req.headers.authorization?.replace('Bearer ', '');
  if (!token) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  const { data: { user }, error } = await supabaseAdmin.auth.getUser(token);
  if (error || !user) {
    return res.status(401).json({ error: 'Invalid token' });
  }

  req.user = user;
  next();
}

// Get user's saved wallets
router.get('/api/user/wallets', requireAuth, async (req: any, res: any) => {
  const { data, error } = await supabaseAdmin
    .from('saved_wallets')
    .select('*')
    .eq('user_id', req.user.id);

  if (error) {
    return res.status(500).json({ error: 'Failed to fetch wallets' });
  }

  res.json(data);
});

// Add wallet to user account
router.post('/api/user/wallets', requireAuth, async (req: any, res: any) => {
  const validation = addWalletSchema.safeParse(req.body);
  if (!validation.success) {
    return res.status(400).json({ error: validation.error.message });
  }

  const { address, label, blockchain } = validation.data;

  const { data, error } = await supabaseAdmin
    .from('saved_wallets')
    .insert({
      user_id: req.user.id,
      address,
      label: label || 'Unnamed Wallet',
      blockchain,
    })
    .select()
    .single();

  if (error) {
    if (error.code === '23505') { // Unique constraint violation
      return res.status(400).json({ error: 'Wallet already saved' });
    }
    return res.status(500).json({ error: 'Failed to save wallet' });
  }

  res.json(data);
});

// Remove wallet
router.delete('/api/user/wallets/:id', requireAuth, async (req: any, res: any) => {
  const { error } = await supabaseAdmin
    .from('saved_wallets')
    .delete()
    .eq('id', req.params.id)
    .eq('user_id', req.user.id); // Ensure user owns the wallet

  if (error) {
    return res.status(500).json({ error: 'Failed to delete wallet' });
  }

  res.json({ success: true });
});

export default router;
```

---

## 6. Frontend Implementation

### 6.1 Install Dependencies

```bash
npm install @supabase/supabase-js
```

### 6.2 Create Auth Context

**File:** `client/src/contexts/AuthContext.tsx`
```typescript
import { createContext, useContext, useEffect, useState, ReactNode } from 'react';
import { supabase } from '@/lib/supabase';
import type { User, Session } from '@supabase/supabase-js';

interface AuthContextType {
  user: User | null;
  session: Session | null;
  isLoading: boolean;
  signInWithTwitter: () => Promise<void>;
  signInWithDiscord: () => Promise<void>;
  signOut: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      setUser(session?.user ?? null);
      setIsLoading(false);
    });

    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
      setSession(session);
      setUser(session?.user ?? null);
    });

    return () => subscription.unsubscribe();
  }, []);

  const signInWithTwitter = async () => {
    await supabase.auth.signInWithOAuth({
      provider: 'twitter',
      options: {
        redirectTo: `${window.location.origin}/`,
      },
    });
  };

  const signInWithDiscord = async () => {
    await supabase.auth.signInWithOAuth({
      provider: 'discord',
      options: {
        redirectTo: `${window.location.origin}/`,
        scopes: 'identify email guilds guilds.members.read',
      },
    });
  };

  const signOut = async () => {
    await supabase.auth.signOut();
  };

  return (
    <AuthContext.Provider value={{ user, session, isLoading, signInWithTwitter, signInWithDiscord, signOut }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider');
  }
  return context;
}
```

### 6.3 Create Auth UI Components

**File:** `client/src/components/auth/AuthButtons.tsx`
```typescript
import { Button } from '@/components/ui/button';
import { useAuth } from '@/contexts/AuthContext';
import { Twitter, MessageSquare } from 'lucide-react';

export function AuthButtons() {
  const { signInWithTwitter, signInWithDiscord } = useAuth();

  return (
    <div className="flex items-center gap-2">
      <Button variant="outline" size="sm" onClick={signInWithTwitter}>
        <Twitter className="w-4 h-4 mr-2" />
        Twitter
      </Button>
      <Button variant="outline" size="sm" onClick={signInWithDiscord}>
        <MessageSquare className="w-4 h-4 mr-2" />
        Discord
      </Button>
    </div>
  );
}
```

**File:** `client/src/components/auth/UserDropdown.tsx`
```typescript
import { useAuth } from '@/contexts/AuthContext';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Button } from '@/components/ui/button';
import { User, Wallet, LogOut, Settings } from 'lucide-react';

export function UserDropdown() {
  const { user, signOut } = useAuth();

  if (!user) return null;

  const username = user.user_metadata?.user_name || user.user_metadata?.full_name || 'User';
  const avatar = user.user_metadata?.avatar_url;

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="outline" size="sm" className="flex items-center gap-2">
          {avatar ? (
            <img src={avatar} alt={username} className="w-6 h-6 rounded-full" />
          ) : (
            <User className="w-4 h-4" />
          )}
          <span>{username}</span>
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-56">
        <DropdownMenuLabel>My Account</DropdownMenuLabel>
        <DropdownMenuSeparator />
        <DropdownMenuItem>
          <Wallet className="w-4 h-4 mr-2" />
          My Wallets
        </DropdownMenuItem>
        <DropdownMenuItem>
          <Settings className="w-4 h-4 mr-2" />
          Settings
        </DropdownMenuItem>
        <DropdownMenuSeparator />
        <DropdownMenuItem onClick={() => signOut()}>
          <LogOut className="w-4 h-4 mr-2" />
          Logout
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

### 6.4 Update App.tsx

```typescript
import { AuthProvider } from '@/contexts/AuthContext';

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <AuthProvider>  {/* NEW */}
        <WalletConnectionProvider>
          <TooltipProvider>
            <Toaster />
            <Router />
          </TooltipProvider>
        </WalletConnectionProvider>
      </AuthProvider>
    </QueryClientProvider>
  );
}
```

### 6.5 Update Dashboard Header

**File:** `client/src/pages/Dashboard.tsx`
```tsx
import { AuthButtons } from '@/components/auth/AuthButtons';
import { UserDropdown } from '@/components/auth/UserDropdown';
import { useAuth } from '@/contexts/AuthContext';

// Inside Dashboard component:
const { user } = useAuth();

// In header section:
<div className="flex items-center justify-between">
  <div>
    <h1>Crypto Live</h1>
  </div>
  <div className="flex items-center gap-3">
    <PortfolioDialog />
    <JupiterSwap />
    {user ? <UserDropdown /> : <AuthButtons />}  {/* NEW */}
    <SettingsPanel />
  </div>
</div>
```

---

## 7. MVP Implementation Steps

### Step 1: Supabase Setup (30 min)
- [ ] Create Supabase project
- [ ] Copy project URL and API keys
- [ ] Configure Twitter OAuth2 provider
- [ ] Configure Discord OAuth2 provider
- [ ] Create database tables (run SQL in Supabase editor)

### Step 2: Backend Setup (30 min)
- [ ] Install `@supabase/supabase-js`
- [ ] Create `server/config/supabase.ts`
- [ ] Create `server/services/discordRoleService.ts`
- [ ] Create `server/routes/wallets.ts` (user-scoped wallet API)
- [ ] Add environment variables to `.env`
- [ ] Update `server/routes.ts` to import wallet routes

### Step 3: Frontend Setup (1 hour)
- [ ] Install `@supabase/supabase-js`
- [ ] Create `client/src/lib/supabase.ts`
- [ ] Create `client/src/contexts/AuthContext.tsx`
- [ ] Create `client/src/components/auth/AuthButtons.tsx`
- [ ] Create `client/src/components/auth/UserDropdown.tsx`
- [ ] Wrap `App.tsx` with `AuthProvider`
- [ ] Update Dashboard header to show AuthButtons/UserDropdown

### Step 4: Update Portfolio to Use Auth (30 min)
- [ ] Update `AddWalletDialog.tsx` to save to Supabase if authenticated
- [ ] Fetch wallets from `/api/user/wallets` for authenticated users
- [ ] Fall back to in-memory storage for anonymous users

### Step 5: Testing (30 min)
- [ ] Test Twitter login flow
- [ ] Test Discord login flow
- [ ] Test wallet saving with auth
- [ ] Test wallet persistence across sessions
- [ ] Test Discord role verification
- [ ] Test logout

### Step 6: Build & Deploy (15 min)
- [ ] `npm run build`
- [ ] `pm2 restart cryptostream-backend`
- [ ] Test on production

---

## 8. MVP User Flow

```
1. Anonymous user visits dashboard
   → Can view public data
   → Wallets saved in-memory (lost on refresh)

2. User clicks "Login with Twitter"
   → Redirects to Twitter authorization
   → Twitter redirects back to dashboard
   → User sees avatar + username in header
   → UserDropdown available

3. User opens Portfolio overlay
   → Adds wallet
   → Wallet saved to Supabase (persists forever)
   → Can access wallet from any device

4. User clicks "Login with Discord"
   → Redirects to Discord authorization
   → Backend verifies guild membership + role
   → If role 1435799986423205951 found: badge added to profile
   → Badge shown in UserDropdown

5. User logs out
   → Session cleared
   → Returns to anonymous state
```

---

## 9. Security Features

### Row Level Security (RLS)
- Users can only access their own wallets, badges, profile
- Supabase enforces at database level (impossible to bypass)
- Service role key only used server-side for admin operations

### Session Management
- Supabase handles JWT tokens automatically
- Tokens stored in httpOnly cookies (XSS protection)
- Refresh tokens for session persistence

### OAuth Security
- State parameter prevents CSRF
- Supabase handles callback verification
- No manual token management needed

---

## 10. Cost Estimate (Supabase Free Tier)

| Resource | Free Tier | Estimated Usage | Status |
|----------|-----------|-----------------|--------|
| Database | 500 MB | ~10 MB (1000 users) | ✅ Plenty |
| Auth users | Unlimited | N/A | ✅ Free |
| API requests | Unlimited | N/A | ✅ Free |
| Bandwidth | 2 GB/month | ~500 MB/month | ✅ Safe |
| Storage | 1 GB | Not needed | ✅ N/A |

**Verdict:** Free tier is sufficient for MVP and early growth!

---

## 11. Next Steps After MVP

### Phase 2: Enhanced Features (Future)
- Watchlists (save token lists)
- Price alerts (notify when price hits target)
- Trading history (parse blockchain transactions)
- Portfolio analytics (P&L charts)

### Phase 3: Social Features (Future)
- Follow other traders
- Share portfolio snapshots
- Leaderboards

---

**End of MVP Plan**

*Ready to implement! Estimated time: 3-4 hours*
